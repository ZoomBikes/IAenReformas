// Prisma Schema - Sistema de Presupuestos de Reformas

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum TipoObra {
  COCINA
  BANO
  SUELOS
  PINTURA
  REFORMA_COMPLETA
  OTROS
}

enum EstadoInmueble {
  NUEVO
  RECIENTE
  ANTIGUO
}

enum TipoTrabajo {
  CAMBIO_TARIMA
  PINTURA_PAREDES
  AZULEJOS
  FONTANERIA
  ELECTRICIDAD
  CARPINTERIA
  OTROS
}

enum Calidad {
  BASICA
  ESTANDAR
  PREMIUM
}

enum UnidadMedida {
  METROS_CUADRADOS
  METROS_LINEALES
  UNIDADES
}

enum EstadoPresupuesto {
  BORRADOR
  ENVIADO
  ACEPTADO
  RECHAZADO
}

enum EstadoLead {
  NUEVO
  CONTACTADO
  CALIFICADO
  CONVERTIDO
  DESCARTADO
}

enum EstadoObra {
  PLANIFICADA
  EN_PROGRESO
  PAUSADA
  COMPLETADA
  CANCELADA
}

enum EstadoTarea {
  PENDIENTE
  EN_PROGRESO
  COMPLETADA
  CANCELADA
}

enum EstadoOrdenCompra {
  BORRADOR
  ENVIADA
  CONFIRMADA
  EN_TRANSITO
  RECIBIDA
  CANCELADA
}

enum EstadoContrato {
  BORRADOR
  ACTIVO
  COMPLETADO
  CANCELADO
}

enum TipoPago {
  MATERIALES
  MANO_OBRA
  SUBCONTRATA
  OTROS
}

enum EstadoSeguimiento {
  EN_PLAZO
  EN_RIESGO
  RETRASADO
}

model Cliente {
  id           String        @id @default(cuid())
  nombre       String
  telefono     String?
  email        String?
  direccion    String?
  tipo         String? // particular, empresa, etc.
  notas        String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  presupuestos Presupuesto[]
  obras        Obra[]
  leads        Lead[]
  llamadasFrio LlamadaFrio[]

  @@map("clientes")
}

model Presupuesto {
  id        String  @id @default(cuid())
  clienteId String
  cliente   Cliente @relation(fields: [clienteId], references: [id], onDelete: Cascade)

  // Información del proyecto
  direccionObra   String
  tipoObra        TipoObra
  descripcionObra String? // Descripción de la obra
  metrosTotales   Float
  numHabitaciones Int
  numBanos        Int
  alturaTechos    Float // En metros, necesario para cálculos
  estadoInmueble  EstadoInmueble

  // Datos estructurados para visualización
  habitaciones Json? // Array de habitaciones con medidas (JSON)

  // Cálculos (realizados por sistema, no IA)
  subtotal Float
  iva      Float @default(21.0) // Porcentaje fijo
  total    Float

  // Explicación generada por IA (solo texto descriptivo)
  explicacionIA String? @db.Text

  // Metadata
  estado        EstadoPresupuesto @default(BORRADOR)
  fechaCreacion DateTime          @default(now())
  fechaValidez  DateTime?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  trabajos TrabajoPresupuesto[]
  obra     Obra?

  @@map("presupuestos")
}

model TrabajoPresupuesto {
  id            String      @id @default(cuid())
  presupuestoId String
  presupuesto   Presupuesto @relation(fields: [presupuestoId], references: [id], onDelete: Cascade)

  tipoTrabajo    TipoTrabajo
  descripcion    String
  cantidad       Float // m², unidades, etc.
  unidad         UnidadMedida
  precioUnitario Float
  precioTotal    Float

  // Configuraciones específicas del trabajo
  calidad Calidad @default(ESTANDAR)

  // Flags específicos según tipo de trabajo
  necesitaAlisado     Boolean @default(false)
  necesitaPicado      Boolean @default(false)
  necesitaImprimacion Boolean @default(true)
  numManosPintura     Int     @default(2)

  // Información adicional para cálculos exactos
  perimetro            Float? // Para pintura (m lineales)
  superficiePuertas    Float? // m² a restar
  superficieVentanas   Float? // m² a restar
  tieneSoladoExistente Boolean @default(false)

  // Explicación generada por IA (solo para este trabajo)
  explicacionIA String? @db.Text

  createdAt DateTime @default(now())

  componentes ComponenteTrabajo[]

  @@map("trabajos_presupuesto")
}

model ComponenteTrabajo {
  id        String             @id @default(cuid())
  trabajoId String
  trabajo   TrabajoPresupuesto @relation(fields: [trabajoId], references: [id], onDelete: Cascade)

  nombre         String // Ej: "Picado de solado", "Autonivelado"
  descripcion    String?
  cantidad       Float
  unidad         String
  precioUnitario Float
  precioTotal    Float

  orden Int // Para ordenar en el desglose

  createdAt DateTime @default(now())

  @@map("componentes_trabajo")
}

model PlantillaTrabajo {
  id     String      @id @default(cuid())
  tipo   TipoTrabajo
  nombre String

  // Trabajos relacionados que se activan automáticamente
  trabajosRelacionados Json // Array de componentes que se añaden automáticamente

  // Precios base por calidad
  preciosBase Json // { basica: {...}, estandar: {...}, premium: {...} }

  // Reglas de cálculo
  multiplicadores Json? // Para ajustes según condiciones

  activo    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("plantillas_trabajo")
}

// ========== MÓDULO CRM ==========

model Lead {
  id            String     @id @default(cuid())
  nombre        String
  telefono      String?
  email         String?
  direccion     String?
  origen        String? // web, referencia, publicidad, etc.
  estado        EstadoLead @default(NUEVO)
  notas         String?    @db.Text
  valorEstimado Float? // Valor estimado del presupuesto
  clienteId     String? // Si se convierte en cliente
  cliente       Cliente?   @relation(fields: [clienteId], references: [id], onDelete: SetNull)
  campanaId     String?
  campana       Campana?   @relation(fields: [campanaId], references: [id], onDelete: SetNull)
  llamadasFrio  LlamadaFrio[]
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  @@map("leads")
}

model Campana {
  id          String    @id @default(cuid())
  nombre      String
  descripcion String?   @db.Text
  tipo        String? // web, social, email, etc.
  fechaInicio DateTime?
  fechaFin    DateTime?
  presupuesto Float?
  gastoReal   Float?    @default(0)
  activa      Boolean   @default(true)
  leads       Lead[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("campanas")
}

// ========== MÓDULO PLANIFICACIÓN ==========

model Obra {
  id                   String                @id @default(cuid())
  presupuestoId        String?               @unique
  presupuesto          Presupuesto?          @relation(fields: [presupuestoId], references: [id], onDelete: SetNull)
  clienteId            String
  cliente              Cliente               @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  nombre               String
  direccion            String
  descripcion          String?               @db.Text
  estado               EstadoObra            @default(PLANIFICADA)
  fechaInicio          DateTime?
  fechaFinPrevista     DateTime?
  fechaFinReal         DateTime?
  presupuestoTotal     Float // Presupuesto inicial
  costeReal            Float?                @default(0)
  avance               Float?                @default(0) // Porcentaje 0-100
  tareas               Tarea[]
  seguimientoCostes    SeguimientoCoste[]
  pagos                Pago[]
  contratos            ContratoSubcontrata[]
  facturasTrabajadores FacturaTrabajador[]
  ordenesCompra        OrdenCompra[]
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt

  @@map("obras")
}

model Tarea {
  id               String      @id @default(cuid())
  obraId           String
  obra             Obra        @relation(fields: [obraId], references: [id], onDelete: Cascade)
  nombre           String
  descripcion      String?     @db.Text
  tipo             String? // materiales, mano_obra, subcontrata, etc.
  estado           EstadoTarea @default(PENDIENTE)
  prioridad        Int?        @default(3) // 1=alta, 2=media, 3=baja
  fechaInicio      DateTime?
  fechaFinPrevista DateTime?
  fechaFinReal     DateTime?
  responsable      String? // Nombre del responsable
  horasEstimadas   Float?
  horasReales      Float?
  costeEstimado    Float?
  costeReal        Float?
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  @@map("tareas")
}

// ========== MÓDULO COMPRAS ==========

model Proveedor {
  id        String                @id @default(cuid())
  nombre    String
  contacto  String? // Nombre de contacto
  telefono  String?
  email     String?
  direccion String?
  tipo      String? // materiales, herramientas, etc.
  notas     String?               @db.Text
  activo    Boolean               @default(true)
  ordenes   OrdenCompra[]
  contratos ContratoSubcontrata[]
  pagos     Pago[]
  createdAt DateTime              @default(now())
  updatedAt DateTime              @updatedAt

  @@map("proveedores")
}

model OrdenCompra {
  id                   String            @id @default(cuid())
  proveedorId          String
  proveedor            Proveedor         @relation(fields: [proveedorId], references: [id], onDelete: Cascade)
  obraId               String?
  obra                 Obra?             @relation(fields: [obraId], references: [id], onDelete: SetNull)
  numero               String            @unique // Número de orden
  descripcion          String?           @db.Text
  estado               EstadoOrdenCompra @default(BORRADOR)
  fechaEmision         DateTime          @default(now())
  fechaEntregaPrevista DateTime?
  fechaEntregaReal     DateTime?
  subtotal             Float             @default(0)
  iva                  Float             @default(21.0)
  total                Float             @default(0)
  items                ItemOrdenCompra[]
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt

  @@map("ordenes_compra")
}

model ItemOrdenCompra {
  id               String      @id @default(cuid())
  ordenCompraId    String
  ordenCompra      OrdenCompra @relation(fields: [ordenCompraId], references: [id], onDelete: Cascade)
  descripcion      String
  cantidad         Float
  unidad           String // m², unidades, kg, etc.
  precioUnitario   Float
  precioTotal      Float
  recibido         Boolean     @default(false)
  cantidadRecibida Float?      @default(0)
  createdAt        DateTime    @default(now())

  @@map("items_orden_compra")
}

// ========== MÓDULO SUBCONTRATAS ==========

model ContratoSubcontrata {
  id               String         @id @default(cuid())
  proveedorId      String
  proveedor        Proveedor      @relation(fields: [proveedorId], references: [id], onDelete: Cascade)
  obraId           String
  obra             Obra           @relation(fields: [obraId], references: [id], onDelete: Cascade)
  nombre           String
  descripcion      String?        @db.Text
  tipoTrabajo      String? // fontanería, electricidad, etc.
  estado           EstadoContrato @default(BORRADOR)
  fechaInicio      DateTime?
  fechaFinPrevista DateTime?
  fechaFinReal     DateTime?
  importeTotal     Float
  importePagado    Float?         @default(0)
  porcentajeAvance Float?         @default(0)
  notas            String?        @db.Text
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  @@map("contratos_subcontrata")
}

// ========== MÓDULO CONTROL DE COSTES ==========

model SeguimientoCoste {
  id            String            @id @default(cuid())
  obraId        String
  obra          Obra              @relation(fields: [obraId], references: [id], onDelete: Cascade)
  concepto      String // Descripción del coste
  tipo          TipoPago
  presupuestado Float // Coste presupuestado
  real          Float?            @default(0) // Coste real
  diferencia    Float? // Diferencia (real - presupuestado)
  porcentaje    Float? // Porcentaje del total
  fecha         DateTime          @default(now())
  notas         String?           @db.Text
  estado        EstadoSeguimiento @default(EN_PLAZO)
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  @@map("seguimiento_costes")
}

model Pago {
  id          String     @id @default(cuid())
  obraId      String
  obra        Obra       @relation(fields: [obraId], references: [id], onDelete: Cascade)
  concepto    String
  tipo        TipoPago
  importe     Float
  fecha       DateTime   @default(now())
  metodo      String? // transferencia, efectivo, etc.
  proveedorId String?
  proveedor   Proveedor? @relation(fields: [proveedorId], references: [id], onDelete: SetNull)
  notas       String?    @db.Text
  createdAt   DateTime   @default(now())

  @@map("pagos")
}

// ========== MÓDULO FACTURAS TRABAJADORES ==========

enum EstadoFacturaTrabajador {
  PENDIENTE
  ENVIADA
  PAGADA
  RECHAZADA
}

model FacturaTrabajador {
  id                 String                  @id @default(cuid())
  trabajadorNombre   String
  trabajadorDni      String?
  trabajadorTelefono String?
  concepto           String
  importe            Float
  fechaFactura       DateTime
  fechaRegistro      DateTime                @default(now())
  estado             EstadoFacturaTrabajador @default(PENDIENTE)

  // Datos de la factura escaneada
  imagenUrl      String? // URL de la imagen de la factura
  imagenBase64   String? @db.Text // Base64 para almacenamiento simple
  datosExtraidos Json? // Datos extraídos por OCR (opcional)

  // Relaciones
  obraId String?
  obra   Obra?   @relation(fields: [obraId], references: [id], onDelete: SetNull)

  // Metadatos
  notas            String?   @db.Text
  enviadoGestor    Boolean   @default(false)
  fechaEnvioGestor DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@map("facturas_trabajadores")
}

// ========== MÓDULO LLAMADAS EN FRÍO ==========

enum EstadoLlamada {
  PENDIENTE
  LLAMADA_REALIZADA
  NO_CONTESTA
  RECHAZADA
  REUNION_AGENDADA
  SOLICITA_INFO
  NO_INTERESADO
  COMPLETADA
}

enum ResultadoLlamada {
  REUNION
  SOLICITA_INFO
  NO_INTERES
  NO_CONTESTA
  RECHAZADA
  OTRO
}

model LlamadaFrio {
  id              String        @id @default(cuid())
  nombre          String        // Nombre del contacto
  telefono        String        // Teléfono de contacto
  email           String?       // Email (opcional)
  agencia         String?       // Agencia inmobiliaria
  direccion       String?       // Dirección completa
  codigoPostal    String?       // Código postal extraído de dirección
  profileUrl      String?       // URL del perfil
  notas           String?       @db.Text // Notas adicionales
  
  // Estado y seguimiento
  estado          EstadoLlamada @default(PENDIENTE)
  haLlamado       Boolean       @default(false) // Si se ha realizado la llamada
  fechaLlamada    DateTime?     // Fecha/hora de la llamada realizada
  fechaAgendada   DateTime?     // Si se agendó una reunión
  duracion        Int?          // Duración en segundos
  
  // Resultados de la llamada
  resultado       ResultadoLlamada? // Resultado de la llamada
  resultadoDetalle String?       @db.Text // Detalle del resultado
  interesado      Boolean?      // Si mostró interés
  valorEstimado   Float?        // Valor estimado si mostró interés
  siguienteAccion String?       @db.Text // Próxima acción a realizar
  
  // Rastreo oculto de llamadas (para análisis)
  historialLlamadas Json?       // Array de llamadas con timestamps: [{fecha, hora, duracion, resultado}]
  
  // Relación con cliente/lead (si se convierte)
  clienteId       String?
  cliente         Cliente?      @relation(fields: [clienteId], references: [id], onDelete: SetNull)
  leadId          String?
  lead            Lead?         @relation(fields: [leadId], references: [id], onDelete: SetNull)
  
  // Metadata
  origen          String?       // Origen del CSV o importación
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@map("llamadas_frio")
}
